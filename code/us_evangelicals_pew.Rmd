---
output:
  html_document: default
  html_notebook: default
---

```{r setup, include=FALSE}

library(haven)
require(dplyr)
require(ggplot2)
require(magrittr)
require(mirt)
require(tidyr)
require(plotly)
require(stringr)
require(knitr)

source('calc_points_func_V3.R')

knitr::render_jekyll()

set.seed(111379)

Dataset_Pew <- read_sav("Dataset - Pew Research Center 2014 Religious Landscape Study National Telephone Survey - Version 1.1 - December 1 2016.sav")

#Need to relabel/relevel some variables to calculate correct reference categories

Dataset_Pew$RELTRAD <- as_factor(Dataset_Pew$RELTRAD)
Dataset_Pew$RELTRAD <- relevel(Dataset_Pew$RELTRAD,"Don't know/refused - no information on religious identity")
levels(Dataset_Pew$RELTRAD) <- c("Don't Know","Evangelical<br>Protestant","Mainline<br>Protestant",                           "Black<br>Protestant", "Catholic", "Mormon", "Orthodox<br>Christian", "Jehovah's<br>Witness","Other<br>Christian","Jewish","Muslim","Buddhist","Hindu","Other<br>Religions","Other<br>Faiths","None")

Dataset_Pew$RELTRAD <- recode_factor(Dataset_Pew$RELTRAD,'Other<br>Religions'="Other<br>Faiths")

levels(Dataset_Pew$RELTRAD) <- c("Don't Know","Buddhist","Evangelical<br>Protestant","Mainline<br>Protestant",                           "Black<br>Protestant", "Catholic", "Mormon", "Orthodox<br>Christian", "Jehovah's<br>Witness","Other<br>Christian","Jewish","Muslim","Hindu","Other<br>Faiths","None")

Dataset_Pew$income <- str_extract(as.character(as_factor(Dataset_Pew$income)),pattern = '\\$[1-9]+.+')
Dataset_Pew$income <- as_factor(Dataset_Pew$income)
levels(Dataset_Pew$qi2g) <- c('Never','Seldom', 'Several times a year','Once or twice a month','At least once a week')

data <- Dataset_Pew

#Need to use survey weights. Won't change actual analysis very much, but still a good thing to do

weights <- Dataset_Pew$WEIGHT

# Keep variables

data %<>% select(qi2g,qi2d,qi2b,qi2a,qi1,qh2,qh1,qg7b,qg7,qg6,qg5,qg1c,qg3,qg1,qg1b,qf2,
                 attend,born,racethn,marital,qb31,qb30,qb22,qb21,qb20,
                 qb21,qb22,qb20,qb2a,qb2c,qb2b,qb2d,qb1c,qb1b,qb1a,qa1,qi3,qp3rec,educ,agerec,
                 qm5a,qm5b,qm5d,qm5e,qm5f,qm5g,party,ideo,income,RELTRAD)

ordinal_vars <- c('qi2g','qi2d','qi2b','qi2a','qi1','qg1b','qf2','attend','qb22','qb21','qb1c',
                  'qb1b','qb1a','qa1','educ','agerec','ideo','income')
binary_vars <- c('qh2','qh1','qg7','qg7b','qg6','qg5','qg1c','qg3','qg1','born','qb30','qb20',
                 'qb2a','qb2c','qb2b','qb2d','qi3','qp3rec','qm5a','qm5b','qm5d','qm5e','qm5f','qm5g')
nominal_vars <- names(data)[!(names(data) %in% c(ordinal_vars,binary_vars))]

all_vars <- c(ordinal_vars,binary_vars,nominal_vars)

# Order by these categories to make it easier to code them for the IRT model

data %<>% select(one_of(c(ordinal_vars,binary_vars,nominal_vars)))

data %<>% as_factor('labels')

keep_labels <- lapply(data,levels)

data %<>% mutate_all(funs(ifelse(grepl(x=.,pattern="VOL|NaN|[Dd]on't [Kk]now|[Rr]efused|Undesignated|Did Not Report"),NA,.)))

keep_labels <- lapply(keep_labels,function(x) {
  x[!grepl(x=x,pattern="VOL|NaN|[Dd]on't [Kk]now|[Rr]efused|Undesignated|Did Not Report")]
})
keep_names <- names(data)
data <-  lapply(1:length(names(data)),function(x) {
  this_col <- data[[x]]
  this_col <- factor(this_col,labels=keep_labels[[x]])
  return(this_col)
})
names(data) <- keep_names
data %<>% as_data_frame

item_types <- c(rep('graded',length(ordinal_vars)),
                rep('2PL',length(binary_vars)),
                rep('nominal',length(nominal_vars)))

data %<>% mutate(RELTRAD = relevel(RELTRAD,'Other<br>Faiths'))
levels(data$income) <- c('$10,000','$20,000','$30,000','$40,000','$50,000','$75,000','$100,000',
                                '$150,000','$150,000 or more')

data$educ <- factor(data$educ,levels= c("Less than high school (Grades 1-8 or no formal schooling)",
                       "High school incomplete (Grades 9-11 or Grade 12 with NO diploma)",
                       "High school graduate (Grade 12 with diploma or GED certificate)",
                       "Some college, no degree (includes some community college)",
                       "Two year associate degree from a college or university",
                       "Four year college or university degree/Bachelor's degree (e.g., BS, BA, AB)",
                       "Some postgraduate or professional schooling, no postgraduate degree (e.g. some graduate school)",
                       "Postgraduate or professional degree, including master's, doctorate, medical or law degree (e.g., MA, MS, PhD, MD...)"),
                    labels=c('Middle School','Some HS','HS Grad','Some College','2-yr Degree','4-yr Degree','Some Grad School','Grad Degree'))

#One of the questions has very odd question order, need to change to make fully ordinal

data$qb1a <- factor(data$qb1a,levels=c("Change for the better","Hasn't made much difference",
                                       "Change for the worse"))
data$qb1b <- factor(data$qb1b,levels=c("Change for the better","Hasn't made much difference",
                                       "Change for the worse"))
data$qb1c <- factor(data$qb1c,levels=c("Change for the better","Hasn't made much difference",
                                       "Change for the worse"))

numeric <- data.matrix(data)
colnames(numeric) <- names(data)

#Unidimensional 2PL Rasch combined ordinal/binary/nominal factor analysis
#If you get an error, just rerun this code. Sometimes the EM algorithm can get stuck in a flat log-likelihood
model <- mirt(numeric,model=2,itemtype=item_types,survey.weights=weights)
person_scores <- fscores(model) %>% as_data_frame

#Need to calculate the min/max points for plotting
#We don't need to use all the scores for these calculations, just a sample
rows_use <- sample(1:nrow(person_scores),1500)
sample_scores <- slice(person_scores,rows_use)
sample_data <- slice(data,rows_use)
sample_Dataset <- slice(Dataset_Pew,rows_use)
#We need to know min/max on all dimensions for plotting the lines correctly
matrix_scores <- as.matrix(sample_scores)
rectangle_scores <- c(min(sample_scores$F1),max(sample_scores$F1),
                      min(sample_scores$F2),max(sample_scores$F2))
names(rectangle_scores) <- c('min_x','max_x','min_y','max_y')

# Need to use the same rotation as the person scores
all_coefs <- coef(model,rotate='oblimin')

all_coefs$GroupPars <- NULL
```

### How We Know Who We Are

This recent election season exposed deep divides within Christians from different denominations. We still don't have good data on exactly how Christians voted--exit polls are not reliable or useful for this question--but it is clear that there are substantial differences among Christians of different ages, churches and ethnicities. In particular, a lot of attention in the media centered on U.S. evangelical Christians, a very broad term that nonetheless is a good predictor of how people vote in elections.

I wanted to look more concretely at the question of what an evangelical Christian is. Instead of defining the term by what an evangelical Christian should be, I examined the question from the perspective of what American say about themselves. The best data source for this question are the Pew surveys on religion and politics, the most recent of which was [just released](http://www.pewforum.org/religious-landscape-study/). Although the survey dates from 2014, it is the best available evidence because it used a very large sample--over 30,000 respondents--and contained a battery of questions concerning both religious and political views. For that reason, it is ideal for understanding what it means to be evangelical.

There are different ways of slicing and dicing this survey. We could, for example, take the question from the survey that asks people if they are evangelical Christians, and then restrict our focus to only this group. However, the evangelical label has been stretched and challenged by so many people that it seems it can describe people with remarkably contrasting beliefs. 

Instead, I used a statistical model^[I used the R package mirt to estimate a 2PL item-response theory model. The full code is available in the code folder of our website's Github at (http://www.github.com/saudiwin/saudiwin.github.io). The model includes sampling weights to account for the sampling design.] to collapse the survey's questions down to two dimensions. I didn't know ahead of time what dimensions these would be, although I suspected that it would collapse to a left-right political scale and a conservative-liberal theology scale. The data analysis largely confirms my prior suspicions. The table below shows the four questions that best explained each of the two dimensions:

    Dimension 1                                       Dimension 2
-----------------------------------------------   --------------------------------------------
Do you believe in God or a universal spirit?          Do you prefer small or big government?
How important is religion in your life?               Does government aid to the poor do more harm than good?
Is the Bible the Word of God?                         Are you conservative/moderate/liberal?
Should homosexuality be accepted by society?          Should homosexuality be accepted by society?

I decided to label the first dimension as religious belief and the second dimension as political opinions. The first appears to measure the difference between secular-liberal and conservative religious beliefs, such as whether a person believes in God and believes that the Bible is the Word of God. The top question for the second dimension reflects a fundamental divide between the political left and the political right: the size of government. Similarly, the second-most divisive political question concerns a perennial debate over the welfare state and whether the government should be involved. What is interesting to note is that the question about homosexuality discriminates on *both* dimensions. Knowing someone's views about homosexuality communicates information about both their religious and political beliefs, so we will certainly examine this question to understand how it fits in the picture.

The plot below shows respondents plotted along these dimensions. We can see from the general shape of the points that there is an oblong, Milky Way galaxy-type shape. This is because people tend to cluster in the top left, liberal religion and liberal politics, and on the bottom right, which is conservative religion and conservative politics. However, there are people who mix and match these beliefs, as they fall into the other two cells. People who are at the exact center are very difficult to classify using either dimension. These are the special cupcakes in the population: they don't conform to our simplistic analysis of religion and politics. But for a large number of Americans, these two dimensions do tell us a lot.

```{r factor_plot, echo=FALSE,warning=FALSE,message=FALSE,fig.width=8.5,fig.height=6}
#Use only 1500 points for better plotting
a <- list(
  x = c(rectangle_scores[['max_x']]+.5,rectangle_scores[['min_x']]-.5,0,-.25),
  y = c(0,0,rectangle_scores[['max_y']]+.6,rectangle_scores[['min_y']]-.6),
  text = c('Traditional<br>Religion',
           'Progressive<br>Religion',
           'Liberal Politics',
           'Conservative Politics'),
  xref = 'x',
  yref = "y",
  showarrow = FALSE,
  ax = 0,
  ay = 0
)

sample_scores %<>% mutate(data_labels=paste0('State: ',as_factor(sample_Dataset$state),'<br>','Age: ',sample_data$agerec,'<br>Income: ',sample_data$income,'<br>Education: ',sample_data$educ),
                          region=as_factor(sample_Dataset$cregion))

sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens',hoverinfo='text') %>% add_markers() %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE)) 
```


We can use the other questions in the survey to analyze how people differ along their demographic background and political opinions, including religious denominations, age, income, government policies, and theological perspectives.

First of all, we can look at the list of religious groups to see how they all stack up against each other. We use a question from the survey that tracked a considerable number of religious categories so that we can look at evangelical Christians compared others. We plot each of these categories on our chart to see how they stand relative to all the respondents. The chart below shows the scores on the first dimensions, religious belief, for several different denominations and religious categories. 


```{r reltrade, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}

ordinal_coefs <- all_coefs[item_types=='graded' | item_types=='2PL']
nominal_coefs <- all_coefs[item_types=='nominal']



reltrad_slope <-  nominal_coefs$RELTRAD[grepl(pattern='a[0-9]',x=attr(nominal_coefs$RELTRAD,'dimnames')[[2]])]
reltrad_coefs <- nominal_coefs$RELTRAD[grepl(pattern='ak[0-9]+',x=attr(nominal_coefs$RELTRAD,'dimnames')[[2]])]
reltrad_diff <- nominal_coefs$RELTRAD[grepl(pattern='d[0-9]+',x=attr(nominal_coefs$RELTRAD,'dimnames')[[2]])]
# there is no way to calculate this equiprobability directly, so we simulate it using random abilities
# abil1 <- sample(seq(rectangle_scores['min_x'],rectangle_scores['max_x'],length.out=10000000),1000000)
# abil2 <- sample(seq(rectangle_scores['min_y'],rectangle_scores['max_y'],length.out=10000000),1000000)
abil_matrix <- expand.grid(seq(-5,5,length.out=1000),seq(-5,5,length.out=1000))
exp_cum_sum <- rowSums(exp(t(t(as.matrix(reltrad_slope)) %*% t(abil_matrix)) %*% t(as.matrix(reltrad_coefs)) + matrix(rep(reltrad_diff,1000000),nrow=1000000,ncol=length(reltrad_diff),byrow=TRUE)))
indiv_sum <- lapply(1:length(reltrad_coefs), function(x) {
  y <- exp(reltrad_coefs[x] * t(t(as.matrix(reltrad_slope)) %*% t(abil_matrix)) + reltrad_diff[x])
})
indiv_probs <- lapply(indiv_sum,function(x) {
  y <- x/exp_cum_sum
  y <- (y - mean(y))^2
  })
# max_probs <- sapply(indiv_probs,function(x)
#   which(x %in% sort(x)[1:100]))
# max_vals <- abil_matrix[max_probs,]
 reltrad_labels <- levels(data$RELTRAD)[2:length(levels(data$RELTRAD))]
# dims <- sapply(1:length(reltrad_coefs), function(x) {
#   (-reltrad_diff[x]*reltrad_slope)/(sqrt(sum(income_slope^2)))
#   
#   })

reltrad_data <- data_frame(dim1=reltrad_slope[[1]]*reltrad_coefs[reltrad_coefs!=0],
                           dim2=reltrad_slope[[2]]*reltrad_coefs[reltrad_coefs!=0],
                        labels=reltrad_labels)
# reltrad_data <- data_frame(dim1=dims[1,-1],
#                            dim2=dims[2,-1],
#                            labels=reltrad_labels)
reltrad_data %>% plot_ly(type='bar',x=~dim1,y=~reorder(labels,dim1),orientation='h',text=~labels) %>% layout(xaxis=list(title='Religous Belief (Progressive to Traditional)'), yaxis=list(title=''),margin=list(l=100),title='Relative Position of Belief in Religious Communities')
```

This plot should be interpreted with caution because it is using a limited number of questions to differentiate respondents along basic beliefs, such as belief in God and whether God's word is inspired. However, it is still interesting that Evangelical Protestants are closer to Muslims than they are to Mainline Protestants or even Jewish people. This graph does seem to capture some intuitive idea about how close and far different religious groups are, at least when it comes to belief in God and the relative proximity between religious groups. As the Catholic philosopher Peter Kreeft once joked,

> I often find more mutual understanding between myself and a fundamentalist Southern Baptist who sincerely believes I am worshipping the great whore of Babylon and on my way to Hell, or with a Muslim who uncompromisingly rejects my belief that Christ is Lord as utter pagan blasphemy, than I find with some active Catholic laity, nuns, especially ex-nuns, priests and even bishops! 

In addition to religious beliefs, these self-reported affiliations tend to differ along political lines as well. We see below that many of the same patterns from religious affiliation are reproduced--nones and evangelicals are on opposite sides of the spectrum--but the relationship is much weaker. While religious differences run the entire length of the scale for the religious dimension, from -2 to +2, political differences are only about one-tenth as large, ranging from -0.2 to +0.2.

```{r relpol, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}

ordinal_coefs <- all_coefs[item_types=='graded' | item_types=='2PL']
nominal_coefs <- all_coefs[item_types=='nominal']
reltrad_slope <-  nominal_coefs$RELTRAD[grepl(pattern='a[0-9]',x=attr(nominal_coefs$RELTRAD,'dimnames')[[2]])]
reltrad_coefs <- nominal_coefs$RELTRAD[grepl(pattern='ak[0-9]+',x=attr(nominal_coefs$RELTRAD,'dimnames')[[2]])]
reltrad_diff <- nominal_coefs$RELTRAD[grepl(pattern='d[0-9]+',x=attr(nominal_coefs$RELTRAD,'dimnames')[[2]])]/reltrad_coefs

reltrad_data <- data_frame(dim1=reltrad_slope[[1]]*reltrad_coefs[reltrad_coefs!=0],
                           dim2=reltrad_slope[[2]]*reltrad_coefs[reltrad_coefs!=0],
                        labels=reltrad_labels)

reltrad_data %>% plot_ly(type='bar',x=~dim2,y=~reorder(labels,dim2),orientation='h',text=~labels) %>% layout(xaxis=list(title='Political Ideology (Conservative to Liberal)'), yaxis=list(title=''),margin=list(l=100),title='Relative Position of Political Opinion for Religious Communities')
```

Next we look at demographic factors. First, do people of varying incomes tend to cluster in certain categories? Answering this question is not straightforward, especially as we want to know how income clusters respondents along both dimensions, religion and politics. The best way is to plot each income category as a line on top of the respondents so that we can see how income divides our respondents along religion and politics.

The chart below shows that the income lines do not divide the survey respondets along religious beliefs (the horizontal dimension), but rather mostly along the vertical dimension, political opinion. Again, this finding is not surprising given that wealthier people in the United States tend to be more conservative. It should be noted too, that these lines are just estimates--it is most likely that people in these income categories will fall in between these lines, but you can find plenty of respondents on the plot that don't fall into these neat buckets. What it does tell us is that, regardless of religious belief, wealthier people are more conservative. On the other hand, we don't know whether a wealthy person is necessarily more or less conservative when it comes to religion: there are both conservative and liberal wealthy believers.


```{r regions, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}
income_slope <-  ordinal_coefs$income[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$income,'dimnames')[[2]])]
income_coefs <- ordinal_coefs$income[grepl(pattern='d[0-9]+',x=attr(ordinal_coefs$income,'dimnames')[[2]])]
income_labels <- levels(data$income)[2:length(levels(data$income))]
dims <- sapply(income_coefs, function(x) (-x*income_slope)/(sqrt(sum(income_slope^2))))
all_points_income <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels=income_labels)

text_data <- data_frame(dim1=dims[1,],dim2=dims[2,],labels=income_labels)

 sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='Income',showlegend=FALSE) %>% add_lines(data=all_points_income,y=~ypoints,x=~xpoints,color=~categories,name='Income Categories',inherit=FALSE) %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',textposition='bottom right',color=I('gray30'))
```

To see the uncertainy in these estimates, I'll color the respondents by whether or not each person makes more than $150,000. Darker colors indicate higher concentrations of wealthy respondents. We see in this chart that there is a clump of dark red in the upper-left corner corresponding to the liberal religion/liberal politics group, but that the clump in the bottom-right corner of conservative religion/conservative politics is much darker. In other words, there are wealthy respondents who are liberal politically, but there is a significantly larger group on the conservative end of the spectrum. This chart primarily serves to show how the lines reflect trends, not absolutes. Some people with high income will be politically liberal even if the majority of wealthy people are conservative.

```{r income_points, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}

# sample_scores$grad_degree <- factor(as.numeric(if_else(sample_data$income %in% c('$100,000','$150,000','$150,000 or more'),
#                        TRUE,FALSE)),labels=c('Under $100K','Over $100K'))
#hoverinfo='text',name='All Respondents',opacity=0.2,size=I(50)
#colors=viridisLite::inferno(10),
#


filter(sample_scores,if_else(sample_data$income %in% '$150,000 or more',TRUE,FALSE)) %>% plot_ly(y=~F2,x=~F1,colors="Reds") %>% add_histogram2dcontour() %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='Number of Respondents with Income Higher than $150K') 
```


Next we'll look at education. This chart shows that the effect education is very different from income--while income tells us how politically conservative or liberal someone is, education is much more likely to tell us how conservative or liberal their religion is. It is also interesting to note that people with a high school education or less are very different than those who have at least some college or more schooling. Those with less than a college education are much more likely to be conservative on their religious views, but this difference doesn't tell us much about their politics.



```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=8.5,fig.height=6}
educ_slope <-  ordinal_coefs$educ[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$educ,'dimnames')[[2]])]
educ_coefs <- ordinal_coefs$educ[grepl(pattern='d[0-9]+',x=attr(ordinal_coefs$educ,'dimnames')[[2]])]
educ_labels <- levels(data$educ)[2:length(levels(data$educ))]
dims <- sapply(educ_coefs, function(x) (-x*educ_slope)/(sqrt(sum(educ_slope^2))))

all_points_educ <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels=educ_labels)

#Offset text labels
dims[2,] <- dims[2,] + seq(from=-2,to=2,length.out=ncol(dims))

text_data <- data_frame(dim1=dims[1,],
                           dim2=dims[2,],
                        labels=educ_labels)


 sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
 yaxis=list(title="",showticklabels = FALSE),
 title='Education',showlegend=FALSE) %>% add_lines(data=all_points_educ,y=~ypoints,x=~xpoints,color=~categories,inherit=FALSE,name='Education',
                                                                             text=~categories) %>% 
   add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',textposition='bottom',color=I('gray30'),showlegend=FALSE)

```


Given these two differing effects of income and education, we can learn something by putting the lines onto the same plot, making a cross-hatch. (Yes, I am literally putting people in boxes). Now we have a bunch of pick-up sticks laid on top of our chart. While it is a bit too much to absorb, it shows how income and education have a complicated interaction when it comes to people's religious and political beliefs. To give just one interesting interpretation, there is a big box of people who have a very high income (more than $150K) but low education (high school or less). These people tend to have very conservative politics and their religious beliefs are also more conservative. On the flip side, the box with people with low income and high education shows that they are more liberal politically and they tend to have more liberal faith. In other words, people are complicated, and we can't always know people's beliefs just by knowing either their education or their income.


```{r,echo=FALSE,  message=FALSE, warning=FALSE,fig.width=10,fig.height=6}
 sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels) %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1,showlegend=FALSE) %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='Both Education and Income') %>% add_lines(data=all_points_income,y=~ypoints,x=~xpoints,color=~categories,linetype=~categories,name='Income Categories',text=~categories,colorscale="Reds",inherit=FALSE) %>% add_lines(data=all_points_educ,y=~ypoints,x=~xpoints,color=~categories,colorscale=I("Greens"),name='Education',
                                                                             text=~categories) 
```


Now we're going to dig deep into how people identify in terms of religion and what that says about their politics. First, we'll look at responses to the question, "How often do you share your faith with non-believers or people from other religious backgrounds?" We see that this question generally corresponds to what we know of religious belief: those who share their faith "once or twice a month or more" tend to also have more conservative beliefs. In addition, there is a slight leftward tilt to the lines, which implies that these people also tend to be more *liberal* politically. It's not a very strong relationship, but it is there, and it is quite interesting. Essentially, it means that people who share their faith a lot are in general more conservative in their religious beliefs. But when we look at people who are equally conservative in religious belief, those who share their faith are also more liberal (or moderate) politically.


```{r,echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}
share_slope <-  ordinal_coefs$qi2g[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$qi2g,'dimnames')[[2]])]
share_coefs <- ordinal_coefs$qi2g[grepl(pattern='d[0-9]+',x=attr(ordinal_coefs$qi2g,'dimnames')[[2]])]
share_labels <- levels(data$qi2g)[2:length(levels(data$qi2g))]
dims <- sapply(share_coefs, function(x) (-x*share_slope)/(sqrt(sum(share_slope^2))))

all_points <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels=share_labels)

#Offset text labels
dims[2,] <- dims[2,] + seq(from=-2,to=2,length.out=ncol(dims))
text_data <- data_frame(dim1=dims[1,],
                        dim2=dims[2,],
                        labels=share_labels)


sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='How often do you share your faith?',showlegend=FALSE) %>% add_lines(data=all_points,y=~ypoints,x=~xpoints,color=~categories,inherit=FALSE,name='shareation',
                                                                                     text=~categories) %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',color=I('gray30'),textposition='bottom right')
```

Another important part of faith is praying. The chart below shows the predicted lines for a question that asks respondents how often they pray. Again, we see that praying is a good indicator of whether someone is more conservative religiously. We also see the same, even slighter, leftward tilt, implying that regardless of belief, people who pray a lot will tilt liberal politically. One additional note is that the "Never" category is way out to the left on religious belief. This happened because there are only a few people who never pray in America--this survey estimates it at about 1 in 10 Americans--so the model pushed them way outside the normal boundaries. This is a case where the model isn't quite as accurate as it could be because of the small number of people in this particular category.


```{r,echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}
qi1_slope <-  ordinal_coefs$qi1[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$qi1,'dimnames')[[2]])]
qi1_coefs <- ordinal_coefs$qi1[grepl(pattern='d[0-9]+',x=attr(ordinal_coefs$qi1,'dimnames')[[2]])]
qi1_labels <- levels(data$qi1)[2:length(levels(data$qi1))]
dims <- sapply(qi1_coefs, function(x) (-x*qi1_slope)/(sqrt(sum(qi1_slope^2))))

all_points <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels=qi1_labels)

#Offset text labels
dims[2,] <- dims[2,] + seq(from=-2,to=2,length.out=ncol(dims))

text_data <- data_frame(dim1=dims[1,],
                        dim2=dims[2,],
                        labels=qi1_labels)


sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='How often do you pray?',showlegend=FALSE) %>% add_lines(data=all_points,y=~ypoints,x=~xpoints,color=~categories,inherit=FALSE,name='qi1ation',
                                                                                     text=~categories) %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',textposition='bottom right',color=I('gray30'))
```

Finally, let's look at how often people attend church (or place of worship), which is also a core component of all religions. These lines show an even more pronounced leftward tilt. This chart means that people who attend church are much more likely to be more conservative in their religious beliefs, but at the same time their political opinions are more liberal than fellow believers who don't attend church.


```{r,echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}
attend_slope <-  ordinal_coefs$attend[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$attend,'dimnames')[[2]])]
attend_coefs <- ordinal_coefs$attend[grepl(pattern='d[0-9]+',x=attr(ordinal_coefs$attend,'dimnames')[[2]])]
attend_labels <- levels(data$attend)[2:length(levels(data$attend))]
dims <- sapply(attend_coefs, function(x) (-x*attend_slope)/(sqrt(sum(attend_slope^2))))

all_points <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels=attend_labels)

#Offset text labels
dims[2,] <- dims[2,] + seq(from=-2,to=2,length.out=ncol(dims))

text_data <- data_frame(dim1=dims[1,],
                        dim2=dims[2,],
                        labels=attend_labels)


sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),showlegend=FALSE,
         title='How often do you attend your place of worship?') %>% add_lines(data=all_points,y=~ypoints,x=~xpoints,color=~categories,inherit=FALSE,name='attendation',
                                                                                     text=~categories) %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',textposition='bottom',color=I('gray30'),showlegend=FALSE)
```


Now that we've diagnosed the very interesting relationship between religious belief and religious practice, we can look at divisive political and religious questions that were asked of respondents. First, we'll use a question that measures the exclusivity of people's religious commitments. This question asked, "is your religion the one, true faith leading to eternal life, or can many religions lead to eternal life?" We only put one line on the chart below because this is a simple yes/no question. Those to the right of the line said that their religion is exclusive, while those to the left said that many religions can lead to eternal life. This question does not tell us much, if anything, about someone's political views, but it does clearly delineate those who are very conservative in their religious beliefs from those who aren't.


```{r,echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}
qh1_slope <-  ordinal_coefs$qh1[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$qh1,'dimnames')[[2]])]
qh1_coefs <- ordinal_coefs$qh1[grepl(pattern='d',x=attr(ordinal_coefs$qh1,'dimnames')[[2]])]
qh1_labels <- levels(data$qh1)[2:length(levels(data$qh1))]
dims <- sapply(qh1_coefs, function(x) (-x*qh1_slope)/(sqrt(sum(qh1_slope^2))))

all_points <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels='Yes    No')

#Offset text labels
dims[2,] <- dims[2,] + seq(from=-2,to=2,length.out=ncol(dims))

text_data <- data_frame(dim1=dims[1,],
                        dim2=1,
                        labels='Yes    No')


sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,showlegend=FALSE,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='Can many religions lead to eternal life?') %>% add_lines(data=all_points,y=~ypoints,x=~xpoints,color=~categories,inherit=FALSE,name='qh1ation',
                                                                                     text=~categories) %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',color=I('gray30'))
```


We first look at the question on homosexuality, which we know is very divisive on both dimensions. This question asked respondents, "should homosexuality be accepted by society?" Unlike religious practice, this question has a strong rightward tilt. This means that those who think homosexuality should be discouraged are more likely to be conservative politically and religiously. This question would appear to exemplify the divide between the groups that match conservative religious beliefs to conservative politics and vice versa. This line cuts the Milky Way galaxy of survey respondents neatly in half. We can also see that there are in general more respondents on the accept homosexuality side than the discourage homosexuality side.


```{r,echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}
qb2a_slope <-  ordinal_coefs$qb2a[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$qb2a,'dimnames')[[2]])]
qb2a_coefs <- ordinal_coefs$qb2a[grepl(pattern='d',x=attr(ordinal_coefs$qb2a,'dimnames')[[2]])]
qb2a_labels <- levels(data$qb2a)[2:length(levels(data$qb2a))]
dims <- sapply(qb2a_coefs, function(x) (-x*qb2a_slope)/(sqrt(sum(qb2a_slope^2))))

all_points <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels='Yes    No')



text_data <- data_frame(dim1=all_points$xpoints[600],
                        dim2=all_points$ypoints[600],
                        labels='Yes    No')


sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,showlegend=FALSE,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='Should homosexuality be accepted by society?') %>% add_lines(data=all_points,y=~ypoints,x=~xpoints,color=~categories,inherit=FALSE,name='qb2aation',
                                                                                     text=~categories)  %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',color=I('gray30'))
```


While homosexuality is a social question with clear religious and political connotations, we can look at whether other political questions are similarly divisive along religious lines. The question below asks respondents whether they think government aid to the poor does more harm than good. The slant on this line is very different--it is nearly completely horizontal. This means that government welfare policy is not an issue that breaks along religious lines. It does divide conservatives and liberals in terms of politics, but it doesn't reflect an underlying religious divide as well. People who have conservative and liberal faith fall on both sides of the question.


```{r,echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}
qb2b_slope <-  ordinal_coefs$qb2b[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$qb2b,'dimnames')[[2]])]
qb2b_coefs <- ordinal_coefs$qb2b[grepl(pattern='d',x=attr(ordinal_coefs$qb2b,'dimnames')[[2]])]
qb2b_labels <- levels(data$qb2b)[2:length(levels(data$qb2b))]
dims <- sapply(qb2b_coefs, function(x) (-x*qb2b_slope)/(sqrt(sum(qb2b_slope^2))))

all_points <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels='No<br><br><br>Yes')



text_data <- data_frame(dim1=all_points$xpoints[450],
                        dim2=all_points$ypoints[450],
                        labels='No<br><br><br>Yes')


sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),showlegend=FALSE,
         title='Does government aid to the poor do more harm than good?') %>% add_lines(data=all_points,y=~ypoints,x=~xpoints,color=~categories,inherit=FALSE,name='qb2bation',
                                                                                     text=~categories) %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',color=I('gray30'))
```


Next we'll examine environmental policy. This question asked respondents whether stricter environmental regulations are worth the added cost. This question is similar to the homosexuality question because it breaks down along political and religious lines. People who think environmental regulations are more important tend to be more liberal both politically and religously, although the relationship is stronger for their political ideology than for their faith.


```{r,echo=FALSE, message=FALSE, warning=FALSE,fig.width=8.5,fig.height=6}
qb2c_slope <-  ordinal_coefs$qb2c[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$qb2c,'dimnames')[[2]])]
qb2c_coefs <- ordinal_coefs$qb2c[grepl(pattern='d',x=attr(ordinal_coefs$qb2c,'dimnames')[[2]])]
qb2c_labels <- levels(data$qb2c)[2:length(levels(data$qb2c))]
dims <- sapply(qb2c_coefs, function(x) (-x*qb2c_slope)/(sqrt(sum(qb2c_slope^2))))

all_points <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels='Yes<br><br><br>No')



text_data <- data_frame(dim1=all_points$xpoints[350],
                        dim2=all_points$ypoints[350],
                        labels='Yes<br><br><br>No')


sample_scores %>% plot_ly(y=~F2,x=~F1,text=~data_labels,colors='Greens') %>% add_markers(hoverinfo='text',name='All Respondents',opacity=0.2,size=1) %>% 
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='Are stricter environmental regulations worth the extra cost?',
         showlegend=FALSE) %>% add_lines(data=all_points,y=~ypoints,x=~xpoints,color=~categories,inherit=FALSE,name='qb2cation',
                                                                                     text=~categories) %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',color=I('gray30'))
```


Based on our analysis so far, we know that core political questions, such as welfare, environmental regulations, and homosexuality can all divide people on both religious and political grounds. The strongest divide is on homosexuality. However, we also find that there is a difference between religious belief and religious practice. People who are similarly conservative in religious belief differ in their political views depending on how much they practice their faith. Those who practice their faith more tend to be more liberal politically as well.

We'll put up one last question from our survey. We know from the polls during the election that there was a divide between younger and older evangelicals over political candidates--generally speaking, older evangelicals preferred Trump, while younger evangelicals were much more likely to prefer third-party candidates or Clinton. For this chart, we'll put up both the age categories and we will color respondents by whether or not they are evangelicals. It does not show a pretty picture. People who are younger tend to be both more liberal politically and religiously. On the flip side, people who are evangelicals are very conservative in general in terms of their religious views, and even compared to people who share the same religious views but wouldn't choose the label evangelical, they are more conservative politically. In total, it seems that there is a looming split in the evangelical church between younger and older believers, with younger believers moving away from their older peers in both religious faith and political ideology.


```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=8.5,fig.height=6}
agerec_slope <-  ordinal_coefs$agerec[grepl(pattern='a[0-9]',x=attr(ordinal_coefs$agerec,'dimnames')[[2]])]
agerec_coefs <- ordinal_coefs$agerec[grepl(pattern='d[0-9]+',x=attr(ordinal_coefs$agerec,'dimnames')[[2]])]
agerec_labels <- levels(data$agerec)[2:length(levels(data$agerec))]
dims <- sapply(agerec_coefs, function(x) (-x*agerec_slope)/(sqrt(sum(agerec_slope^2))))

all_points <- calc_points(dims=dims,rectangle_scores = rectangle_scores,labels=agerec_labels)

all_points_evan <- calc_points(dims=matrix(c(reltrad_data$dim1[2],reltrad_data$dim2[2]),nrow=2,ncol=1),rectangle_scores = rectangle_scores,labels='Evangelicals')
 

text_data <- data_frame(dim1=dims[1,],
                        dim2=dims[2,],
                        labels=agerec_labels)

text_data_evan <- data_frame(dim1=all_points_evan$xpoints[1000],
                             dim2=all_points_evan$ypoints[1000]+.3,
                             labels='Evangelicals')

data_evan <- filter(sample_scores,if_else(sample_data$RELTRAD %in% 'Evangelical<br>Protestant',TRUE,FALSE))

# %>% 
#   add_text(data=text_data_evan,x=~dim1,y=~dim2,text=~labels,color=I('red'),textposition='top center')

# need to drop people who are really old

all_points <- all_points %>% group_by(categories) %>% mutate(mean_x=mean(xpoints)) %>% filter(mean_x<rectangle_scores['max_x'])
text_data <- filter(text_data,labels %in% unique(all_points$categories))
all_points %>% plot_ly(y=~ypoints,x=~xpoints)  %>% add_lines(color=~categories,text=~categories,colors='Greens',hoverinfo='none') %>% add_text(data=text_data,x=~dim1,y=~dim2,text=~labels,name='Point Labels',textposition='bottom',color=I('gray30')) %>% add_histogram2dcontour(data=data_evan,x=~F1,y=~F2,opacity=0.4,hoverinfo='none',colorbar=list(title='# of Evangelicals',xanchor='bottom'),colors='Reds') %>%
  layout(annotations=a,xaxis=list(title="",showticklabels = FALSE),
         yaxis=list(title="",showticklabels = FALSE),
         title='Age & Evangelicals',showlegend=FALSE)

```


This was an exploratory analysis, and these conclusions aren't firm. But they do indicate the nature of politics and religion in America today, and the issues that divide us and unite us. Also, we shouldn't just think of religious identity as a list of questions but also as a list of practices. When we note that certain political issues tend to divide Americans on both religious and political grounds, we can't assume that all Americans are equally devoted to their religious traditions even if they believe them to be true. As is often the case, reality is more complicated than our limited perspectives allow it to be.

The potential conflict between younger and older evangelicals that our last chart illustrates is part of what motivates this web page. We want to offer a space for young evangelicals to hash out their political and religious differences in a setting that is non-confrontational, biblically-oriented, and open to any kind of controversial topic. We don't want to limit ourselves to asking who to vote for every four years, but rather we want to be Christians who follow Christ in a political world.